<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 4 Spatial Analysis | R Spatial Workshop</title>
  <meta name="description" content="This workshop was created for USU’s Ecology Center R workshops on R Spatial." />
  <meta name="generator" content="bookdown 0.25 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 4 Spatial Analysis | R Spatial Workshop" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="This workshop was created for USU’s Ecology Center R workshops on R Spatial." />
  <meta name="github-repo" content="ronanhart/R_spatial_workshop" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 4 Spatial Analysis | R Spatial Workshop" />
  
  <meta name="twitter:description" content="This workshop was created for USU’s Ecology Center R workshops on R Spatial." />
  

<meta name="author" content="Ronan Hart" />


<meta name="date" content="2022-04-06" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="spatial-data-in-r.html"/>
<link rel="next" href="where-to-obtain-data-further-resources.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Ecology Center: R Spatial Workshop</a></li>

<li class="divider"></li>
<li><a href="index.html#url-your-book-url-like-httpsbookdown.orgyihuibookdown" id="toc-url-your-book-url-like-httpsbookdown.orgyihuibookdown"><span class="toc-section-number">1</span> url: your book url like <span>https://bookdown.org/yihui/bookdown</span><span></span></a>
<ul>
<li><a href="index.html#why-gis-in-r" id="toc-why-gis-in-r">Why GIS in R?<span></span></a></li>
<li><a href="index.html#prerequisites-packages-and-preparation" id="toc-prerequisites-packages-and-preparation">Prerequisites, Packages, and Preparation<span></span></a></li>
</ul></li>
<li><a href="gis-basics.html#gis-basics" id="toc-gis-basics"><span class="toc-section-number">2</span> GIS basics<span></span></a>
<ul>
<li><a href="gis-basics.html#datums-projections-and-coordinate-systems" id="toc-datums-projections-and-coordinate-systems"><span class="toc-section-number">2.1</span> Datums, Projections, and Coordinate Systems<span></span></a>
<ul>
<li><a href="gis-basics.html#datums" id="toc-datums">Datums<span></span></a></li>
<li><a href="gis-basics.html#projections" id="toc-projections">Projections<span></span></a></li>
<li><a href="gis-basics.html#coordinate-reference-system" id="toc-coordinate-reference-system">Coordinate Reference System<span></span></a></li>
</ul></li>
<li><a href="gis-basics.html#spatial-data" id="toc-spatial-data"><span class="toc-section-number">2.2</span> Spatial Data<span></span></a>
<ul>
<li><a href="gis-basics.html#vectors" id="toc-vectors">Vectors<span></span></a></li>
<li><a href="gis-basics.html#rasters" id="toc-rasters">Rasters<span></span></a></li>
</ul></li>
<li><a href="gis-basics.html#vectors-vs-rasters-pros-cons" id="toc-vectors-vs-rasters-pros-cons"><span class="toc-section-number">2.3</span> Vectors vs Rasters: pros &amp; cons<span></span></a></li>
</ul></li>
<li><a href="spatial-data-in-r.html#spatial-data-in-r" id="toc-spatial-data-in-r"><span class="toc-section-number">3</span> Spatial Data in R<span></span></a>
<ul>
<li><a href="spatial-data-in-r.html#vectors-1" id="toc-vectors-1"><span class="toc-section-number">3.1</span> Vectors<span></span></a>
<ul>
<li><a href="spatial-data-in-r.html#loading-vector-data-from-a-spreadsheet" id="toc-loading-vector-data-from-a-spreadsheet"><span class="toc-section-number">3.1.1</span> Loading vector data from a spreadsheet<span></span></a></li>
<li><a href="spatial-data-in-r.html#loading-vector-data-from-a-shapefile" id="toc-loading-vector-data-from-a-shapefile"><span class="toc-section-number">3.1.2</span> Loading vector data from a shapefile<span></span></a></li>
<li><a href="spatial-data-in-r.html#projecting-vector-data" id="toc-projecting-vector-data"><span class="toc-section-number">3.1.3</span> Projecting vector data<span></span></a></li>
<li><a href="spatial-data-in-r.html#saving-vector-data" id="toc-saving-vector-data"><span class="toc-section-number">3.1.4</span> Saving vector data<span></span></a></li>
<li><a href="spatial-data-in-r.html#a-note-about-sf-and-tidyverse" id="toc-a-note-about-sf-and-tidyverse">A note about <code>sf</code> and <code>tidyverse</code><span></span></a></li>
<li><a href="spatial-data-in-r.html#your-turn" id="toc-your-turn">Your Turn!<span></span></a></li>
</ul></li>
<li><a href="spatial-data-in-r.html#rasters-1" id="toc-rasters-1"><span class="toc-section-number">3.2</span> Rasters<span></span></a>
<ul>
<li><a href="spatial-data-in-r.html#load-a-raster" id="toc-load-a-raster"><span class="toc-section-number">3.2.1</span> Load a raster<span></span></a></li>
<li><a href="spatial-data-in-r.html#create-a-raster" id="toc-create-a-raster"><span class="toc-section-number">3.2.2</span> Create a raster<span></span></a></li>
<li><a href="spatial-data-in-r.html#project-a-raster" id="toc-project-a-raster"><span class="toc-section-number">3.2.3</span> Project a raster<span></span></a></li>
<li><a href="spatial-data-in-r.html#save-a-raster" id="toc-save-a-raster"><span class="toc-section-number">3.2.4</span> Save a raster<span></span></a></li>
<li><a href="spatial-data-in-r.html#your-turn-1" id="toc-your-turn-1">Your Turn!<span></span></a></li>
</ul></li>
</ul></li>
<li><a href="spatial-analysis.html#spatial-analysis" id="toc-spatial-analysis"><span class="toc-section-number">4</span> Spatial Analysis<span></span></a>
<ul>
<li><a href="spatial-analysis.html#selecting-attributes" id="toc-selecting-attributes"><span class="toc-section-number">4.1</span> Selecting Attributes<span></span></a></li>
<li><a href="spatial-analysis.html#select-features-by-location" id="toc-select-features-by-location"><span class="toc-section-number">4.2</span> Select features by location<span></span></a></li>
<li><a href="spatial-analysis.html#joining-attributes" id="toc-joining-attributes"><span class="toc-section-number">4.3</span> Joining Attributes<span></span></a></li>
<li><a href="spatial-analysis.html#extract-raster-values" id="toc-extract-raster-values"><span class="toc-section-number">4.4</span> Extract Raster Values<span></span></a></li>
<li><a href="spatial-analysis.html#distance" id="toc-distance"><span class="toc-section-number">4.5</span> Distance<span></span></a></li>
<li><a href="spatial-analysis.html#calculate-terrain-characteristics" id="toc-calculate-terrain-characteristics"><span class="toc-section-number">4.6</span> Calculate Terrain Characteristics<span></span></a></li>
<li><a href="spatial-analysis.html#re-classify-rasters" id="toc-re-classify-rasters"><span class="toc-section-number">4.7</span> Re-Classify Rasters<span></span></a></li>
<li><a href="spatial-analysis.html#raster-cell-stats" id="toc-raster-cell-stats"><span class="toc-section-number">4.8</span> Raster Cell Stats<span></span></a></li>
<li><a href="spatial-analysis.html#a-note-about-loops" id="toc-a-note-about-loops"><span class="toc-section-number">4.9</span> A Note About Loops<span></span></a></li>
</ul></li>
<li><a href="where-to-obtain-data-further-resources.html#where-to-obtain-data-further-resources" id="toc-where-to-obtain-data-further-resources"><span class="toc-section-number">5</span> Where to Obtain Data &amp; Further Resources<span></span></a>
<ul>
<li><a href="where-to-obtain-data-further-resources.html#data-sources" id="toc-data-sources"><span class="toc-section-number">5.1</span> Data Sources<span></span></a>
<ul>
<li><a href="where-to-obtain-data-further-resources.html#maps-package" id="toc-maps-package"><span class="toc-section-number">5.1.1</span> <code>maps</code> package<span></span></a></li>
<li><a href="where-to-obtain-data-further-resources.html#utah-gis" id="toc-utah-gis"><span class="toc-section-number">5.1.2</span> Utah GIS<span></span></a></li>
<li><a href="where-to-obtain-data-further-resources.html#other-environmental-rasters" id="toc-other-environmental-rasters"><span class="toc-section-number">5.1.3</span> Other Environmental Rasters<span></span></a></li>
</ul></li>
<li><a href="where-to-obtain-data-further-resources.html#more-resources" id="toc-more-resources"><span class="toc-section-number">5.2</span> More Resources<span></span></a>
<ul>
<li><a href="where-to-obtain-data-further-resources.html#learn-more-about-gis-in-general" id="toc-learn-more-about-gis-in-general"><span class="toc-section-number">5.2.1</span> Learn more about GIS in general<span></span></a></li>
</ul></li>
<li><a href="where-to-obtain-data-further-resources.html#acknowledgements" id="toc-acknowledgements"><span class="toc-section-number">5.3</span> Acknowledgements<span></span></a>
<ul>
<li><a href="where-to-obtain-data-further-resources.html#figure-citations" id="toc-figure-citations"><span class="toc-section-number">5.3.1</span> Figure Citations<span></span></a></li>
</ul></li>
<li><a href="where-to-obtain-data-further-resources.html#cropping" id="toc-cropping"><span class="toc-section-number">5.4</span> Cropping<span></span></a>
<ul>
<li><a href="where-to-obtain-data-further-resources.html#cropping-a-vector" id="toc-cropping-a-vector">Cropping a vector<span></span></a></li>
<li><a href="where-to-obtain-data-further-resources.html#cropping-a-raster" id="toc-cropping-a-raster">Cropping a raster<span></span></a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">R Spatial Workshop</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="spatial-analysis" class="section level1 hasAnchor" number="4">
<h1><span class="header-section-number">Chapter 4</span> Spatial Analysis<a href="spatial-analysis.html#spatial-analysis" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Now let’s do some analysis with the data we’ve acquired already:</p>
<ul>
<li>Sites point data <code>sites_sf</code></li>
<li>Utah freeways <code>fwy_sf_proj</code></li>
</ul>
<p>We also have some data that I’ve included in the exercises portion of the “worksheet”: a different elevation + snow raster stack (this one is in the NW corner of Utah), a set of plots as a point feature, and a polygon feature of land management boundaries in Utah:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="spatial-analysis.html#cb7-1" aria-hidden="true" tabindex="-1"></a>elev_snow_stk</span></code></pre></div>
<pre><code>## class      : RasterStack 
## dimensions : 7401, 5606, 41490006, 3  (nrow, ncol, ncell, nlayers)
## resolution : 30, 30  (x, y)
## extent     : 414639.5, 582819.5, 4428230, 4650260  (xmin, xmax, ymin, ymax)
## crs        : +proj=utm +zone=12 +datum=NAD83 +units=m +no_defs 
## names      : elevation,      swe, snow_depth 
## min values :  1279.897,    0.000,      0.000 
## max values :    4111.6,   1108.0,     3196.0</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="spatial-analysis.html#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(elev_snow_stk)</span></code></pre></div>
<p><img src="_main_files/figure-html/showRaster-1.png" width="672" /></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="spatial-analysis.html#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(plots_sf)</span></code></pre></div>
<pre><code>## Simple feature collection with 6 features and 1 field
## Geometry type: POINT
## Dimension:     XY
## Bounding box:  xmin: 499102.7 ymin: 4528029 xmax: 560979.8 ymax: 4622779
## Projected CRS: NAD83 / UTM zone 12N
##   Plots                 geometry
## 1     A POINT (537889.7 4593484)
## 2     B POINT (560979.8 4586311)
## 3     C POINT (544094.8 4548330)
## 4     D POINT (522850.5 4556870)
## 5     E POINT (551238.5 4528029)
## 6     F POINT (499102.7 4622779)</code></pre>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="spatial-analysis.html#cb12-1" aria-hidden="true" tabindex="-1"></a>manage_sf <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">&quot;data/Exercises/UT_land_management&quot;</span>, <span class="st">&quot;UT_land_management&quot;</span>,</span>
<span id="cb12-2"><a href="spatial-analysis.html#cb12-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">quiet =</span> T) <span class="sc">%&gt;%</span></span>
<span id="cb12-3"><a href="spatial-analysis.html#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="at">crs =</span> <span class="dv">26912</span>)</span></code></pre></div>
<pre><code>## Simple feature collection with 6 features and 5 fields
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: 388066 ymin: 4410117 xmax: 403492.2 ymax: 4414856
## Projected CRS: NAD83 / UTM zone 12N
##   OBJECTID   OWNER AGENCY ADMIN          DESIG                       geometry
## 1        1 Federal    BLM   BLM Bankhead Jones MULTIPOLYGON (((388854 4411...
## 2        2 Federal    BLM   BLM Bankhead Jones MULTIPOLYGON (((394528.1 44...
## 3        3 Federal    BLM   BLM Bankhead Jones MULTIPOLYGON (((388473.6 44...
## 4        4 Federal    BLM   BLM Bankhead Jones MULTIPOLYGON (((399793.3 44...
## 5        5 Federal    BLM   BLM Bankhead Jones MULTIPOLYGON (((389300.1 44...
## 6        6 Federal    BLM   BLM Bankhead Jones MULTIPOLYGON (((403492.2 44...</code></pre>
<p><img src="_main_files/figure-html/showManage-1.png" width="672" /></p>
<p>Let’s plot one of the rasters with our sites point vector and Utah highways line vector. To plot just one raster layer in a stack we can either index it with double brackets or with the name:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="spatial-analysis.html#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># these are different ways to get the same raster layer</span></span>
<span id="cb14-2"><a href="spatial-analysis.html#cb14-2" aria-hidden="true" tabindex="-1"></a>elev_snow_stk[[<span class="dv">1</span>]]</span></code></pre></div>
<pre><code>## class      : RasterLayer 
## band       : 1  (of  3  bands)
## dimensions : 7401, 5606, 41490006  (nrow, ncol, ncell)
## resolution : 30, 30  (x, y)
## extent     : 414639.5, 582819.5, 4428230, 4650260  (xmin, xmax, ymin, ymax)
## crs        : +proj=utm +zone=12 +datum=NAD83 +units=m +no_defs 
## source     : elev_snow_nw_stack.tif 
## names      : elevation 
## values     : 1279.897, 4111.6  (min, max)</code></pre>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="spatial-analysis.html#cb16-1" aria-hidden="true" tabindex="-1"></a>elev_snow_stk<span class="sc">$</span>elevation</span></code></pre></div>
<pre><code>## class      : RasterLayer 
## band       : 1  (of  3  bands)
## dimensions : 7401, 5606, 41490006  (nrow, ncol, ncell)
## resolution : 30, 30  (x, y)
## extent     : 414639.5, 582819.5, 4428230, 4650260  (xmin, xmax, ymin, ymax)
## crs        : +proj=utm +zone=12 +datum=NAD83 +units=m +no_defs 
## source     : elev_snow_nw_stack.tif 
## names      : elevation 
## values     : 1279.897, 4111.6  (min, max)</code></pre>
<pre><code>## Reading layer `utah_freeway&#39; from data source 
##   `C:\Users\Ronan\Box\Ecology Center\R_Spatial_bookdown\Data\Examples\utah_freeway&#39; 
##   using driver `ESRI Shapefile&#39;
## Simple feature collection with 1849 features and 7 fields
## Geometry type: LINESTRING
## Dimension:     XY
## Bounding box:  xmin: -114.0437 ymin: 37.00002 xmax: -109.0513 ymax: 42.00117
## Geodetic CRS:  WGS 84</code></pre>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="spatial-analysis.html#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(elev_snow_stk<span class="sc">$</span>elevation)</span>
<span id="cb19-2"><a href="spatial-analysis.html#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(fwy_sf_proj), <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">add =</span> <span class="cn">TRUE</span>) <span class="co"># add = TRUE will add other elements to the plot without erasing previous elements and creating a new plot </span></span>
<span id="cb19-3"><a href="spatial-analysis.html#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(sites_sf_proj), <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">add =</span> <span class="cn">TRUE</span>) </span>
<span id="cb19-4"><a href="spatial-analysis.html#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(plots_sf), <span class="at">pch =</span> <span class="dv">3</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/plotAll-1.png" width="672" /></p>
<p>(This can also be done with <code>ggplot</code> using <code>as.data.frame</code> but in this case the raster may be too large for R to convert to a dataframe and plot)</p>
<p>Let’s start on some analysis and computations that we can run on these data.</p>
<div id="selecting-attributes" class="section level2 hasAnchor" number="4.1">
<h2><span class="header-section-number">4.1</span> Selecting Attributes<a href="spatial-analysis.html#selecting-attributes" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Perhaps you have vector data and you want to select only certain attributes or attributes that reach a focal threshold. To do so we need to set up a logical statement, and we can do this in base R or in <code>tidyverse</code>.</p>
<p>Let’s say we want to select boundaries that are operated by BLM. In the shapefile of management boundaries, this information is located in the column “AGENCY”</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="spatial-analysis.html#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(manage_sf<span class="sc">$</span>AGENCY)</span></code></pre></div>
<pre><code>##  [1] &quot;BLM&quot;     &quot;BR&quot;      &quot;DOD&quot;     &quot;DOE&quot;     &quot;NPS&quot;     &quot;USFS&quot;    &quot;USFWS&quot;  
##  [8] &quot;Private&quot; &quot;DNR&quot;     &quot;OS&quot;      &quot;SITLA&quot;   &quot;UDOT&quot;    &quot;Tribal&quot;</code></pre>
<p>In base R we can use the function <code>which</code> and in <code>tidyverse</code> we can use the function <code>filter</code></p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="spatial-analysis.html#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># base R</span></span>
<span id="cb22-2"><a href="spatial-analysis.html#cb22-2" aria-hidden="true" tabindex="-1"></a>blm_boundary <span class="ot">&lt;-</span> manage_sf[<span class="fu">which</span>(manage_sf<span class="sc">$</span>AGENCY <span class="sc">==</span> <span class="st">&quot;BLM&quot;</span>), ] </span>
<span id="cb22-3"><a href="spatial-analysis.html#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="spatial-analysis.html#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co"># tidyverse</span></span>
<span id="cb22-5"><a href="spatial-analysis.html#cb22-5" aria-hidden="true" tabindex="-1"></a>blm_boundary <span class="ot">&lt;-</span> manage_sf <span class="sc">%&gt;%</span> </span>
<span id="cb22-6"><a href="spatial-analysis.html#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(AGENCY <span class="sc">==</span> <span class="st">&quot;BLM&quot;</span>)</span>
<span id="cb22-7"><a href="spatial-analysis.html#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="spatial-analysis.html#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb22-9"><a href="spatial-analysis.html#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> manage_sf, <span class="at">col =</span> <span class="st">&quot;grey&quot;</span>, <span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb22-10"><a href="spatial-analysis.html#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> blm_boundary, <span class="at">fill =</span> <span class="st">&quot;red&quot;</span>, <span class="at">col =</span> <span class="st">&quot;grey30&quot;</span>,</span>
<span id="cb22-11"><a href="spatial-analysis.html#cb22-11" aria-hidden="true" tabindex="-1"></a>          <span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">size =</span> <span class="fl">0.1</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/selectBLM-1.png" width="672" /></p>
<p>Using these functions, you can set up any logical statement using <code>==</code>, <code>%in%</code>, <code>&gt;</code>, <code>&gt;=</code>, <code>&lt;</code>, <code>&lt;=</code>, or <code>!</code> and select for the specific attributes you need.</p>
</div>
<div id="select-features-by-location" class="section level2 hasAnchor" number="4.2">
<h2><span class="header-section-number">4.2</span> Select features by location<a href="spatial-analysis.html#select-features-by-location" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Let’s make select the management boundaries based on if they are intersected by a major highway. For <code>sf</code> we’ll use the function <code>st_intersect</code></p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="spatial-analysis.html#cb23-1" aria-hidden="true" tabindex="-1"></a>manage_roads <span class="ot">&lt;-</span> <span class="fu">st_intersects</span>(fwy_sf_proj, manage_sf) <span class="co"># the first argument is the target shape and the second argument the shape we&#39;re selecting from</span></span>
<span id="cb23-2"><a href="spatial-analysis.html#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(manage_roads)</span></code></pre></div>
<pre><code>## [1] &quot;sgbp&quot; &quot;list&quot;</code></pre>
<p>The output is an <code>sgbp</code> object, or “Sparse Geometry Binary Predicate”. Basically it returns a list of vectors of integers, which refer to the indices of each polygon that intersects.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="spatial-analysis.html#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(manage_roads)</span></code></pre></div>
<pre><code>## [1]  1849 14888</code></pre>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="spatial-analysis.html#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(fwy_sf_proj)</span></code></pre></div>
<pre><code>## [1] 1849</code></pre>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="spatial-analysis.html#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(manage_sf)</span></code></pre></div>
<pre><code>## [1] 14888</code></pre>
<p>So the dimensions of this list are the the number of rows in the target shape (the highways) and the number of rows in the intersecting shape (the management boundaries).</p>
<p>Lets look at the first five elements of this list:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="spatial-analysis.html#cb31-1" aria-hidden="true" tabindex="-1"></a>manage_roads[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code></pre></div>
<pre><code>## [[1]]
## [1] 6459
## 
## [[2]]
## [1] 6455
## 
## [[3]]
## [1] 6449
## 
## [[4]]
## [1] 6449
## 
## [[5]]
## [1] 6443</code></pre>
<p>This means that the 1st row of the road polyline intersects with the 6459th row of the management polygon, the 2nd row of the road polyline intersects with the 6455th row of the management polygon, and etc.</p>
<p>If we wanted to know the specifc index of a specific road that intersected with a management boundary, it would be useful to keep all of these indices seperate. Since we just want to know which boundaries intersect a road, we can collapse this whole list together.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="spatial-analysis.html#cb33-1" aria-hidden="true" tabindex="-1"></a>manage_roads_index <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">unlist</span>(manage_roads)) <span class="co"># just pull the unique indices</span></span>
<span id="cb33-2"><a href="spatial-analysis.html#cb33-2" aria-hidden="true" tabindex="-1"></a>manage_roads_intersect <span class="ot">&lt;-</span> manage_sf[manage_roads_index, ] </span>
<span id="cb33-3"><a href="spatial-analysis.html#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="spatial-analysis.html#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb33-5"><a href="spatial-analysis.html#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> manage_sf, <span class="at">col =</span> <span class="st">&quot;grey&quot;</span>, <span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb33-6"><a href="spatial-analysis.html#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> manage_roads_intersect, <span class="at">fill =</span> <span class="st">&quot;red&quot;</span>, <span class="at">col =</span> <span class="st">&quot;grey30&quot;</span>,</span>
<span id="cb33-7"><a href="spatial-analysis.html#cb33-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb33-8"><a href="spatial-analysis.html#cb33-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> fwy_sf_proj, <span class="at">col =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">1</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/intersect-1.png" width="672" /></p>
<p>If you look at the help file for <code>?st_intersects</code>, you’ll see there are a lot of different functions that select features based on another feature.</p>
</div>
<div id="joining-attributes" class="section level2 hasAnchor" number="4.3">
<h2><span class="header-section-number">4.3</span> Joining Attributes<a href="spatial-analysis.html#joining-attributes" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Let’s load in a table of some data collected at each plot</p>
<pre><code>##   Plots      Species       Date AboveGroundBiomass MeanHeight PercentCover
## 1     A R. maritimus 2021-05-01           27.61158  3.7257421     77.75151
## 2     A    B. cernua 2021-05-01           13.18637  4.5355917     65.06243
## 3     A    S. acutus 2021-05-01           68.84413  1.8172373     98.39445
## 4     B R. maritimus 2021-05-02           59.58161  1.2949173     28.84727
## 5     B    B. cernua 2021-05-02           87.44708  0.7372426     48.40372
## 6     B    S. acutus 2021-05-02           35.32842  2.6436731     95.73950</code></pre>
<p>Let’s join this table to the Plots feature so we could do some spatial analysis and mapping of the collected data. To join two tables together, we need to input the two tables and the name of the column that exists in both tables (so the join function knows how to match attributes together). In this case, that would be the Plots column.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="spatial-analysis.html#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(plots_sf<span class="sc">$</span>Plots)</span></code></pre></div>
<pre><code>## [1] &quot;A&quot; &quot;B&quot; &quot;C&quot; &quot;D&quot; &quot;E&quot; &quot;F&quot;</code></pre>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="spatial-analysis.html#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(plot_data<span class="sc">$</span>Plots)</span></code></pre></div>
<pre><code>## [1] &quot;A&quot; &quot;A&quot; &quot;A&quot; &quot;B&quot; &quot;B&quot; &quot;B&quot;</code></pre>
<p>We can use the <code>tidyverse</code>’s <code>join</code> functions. (If you don’t know how joins work, I would recommend looking at the help file by typing <code>?left_join</code> in the console)</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="spatial-analysis.html#cb39-1" aria-hidden="true" tabindex="-1"></a>plots_join <span class="ot">&lt;-</span> <span class="fu">left_join</span>(plots_sf, plot_data, <span class="at">by =</span> <span class="st">&quot;Plots&quot;</span>)</span>
<span id="cb39-2"><a href="spatial-analysis.html#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(plots_join)</span></code></pre></div>
<pre><code>## Simple feature collection with 6 features and 6 fields
## Geometry type: POINT
## Dimension:     XY
## Bounding box:  xmin: 537889.7 ymin: 4593484 xmax: 537889.7 ymax: 4593484
## Projected CRS: NAD83 / UTM zone 12N
##   Plots      Species       Date AboveGroundBiomass MeanHeight PercentCover
## 1     A R. maritimus 2021-05-01           27.61158  3.7257421     77.75151
## 2     A    B. cernua 2021-05-01           13.18637  4.5355917     65.06243
## 3     A    S. acutus 2021-05-01           68.84413  1.8172373     98.39445
## 4     A R. maritimus 2021-05-08           42.73997  0.5477968     65.87027
## 5     A    B. cernua 2021-05-08           68.90326  1.9793263     11.35618
## 6     A    S. acutus 2021-05-08           44.42221  0.4002126     90.92433
##                   geometry
## 1 POINT (537889.7 4593484)
## 2 POINT (537889.7 4593484)
## 3 POINT (537889.7 4593484)
## 4 POINT (537889.7 4593484)
## 5 POINT (537889.7 4593484)
## 6 POINT (537889.7 4593484)</code></pre>
<p>Great! At this point you could then do some spatial analysis based on location, or make a map based on average biomass, for example. However, that’s outside the scope of this workshop.</p>
<p>Joining two tables together is a valuable tool to know, not just for GIS but for any data management.</p>
</div>
<div id="extract-raster-values" class="section level2 hasAnchor" number="4.4">
<h2><span class="header-section-number">4.4</span> Extract Raster Values<a href="spatial-analysis.html#extract-raster-values" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>What if we need to get data from our rasters at our specific site locations? We can use the function <code>extract()</code>.</p>
<p>Let’s load a landcover raster so we can classify the habitat types of our sites</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="spatial-analysis.html#cb41-1" aria-hidden="true" tabindex="-1"></a>landcover <span class="ot">&lt;-</span> <span class="fu">raster</span>(<span class="st">&quot;Data/Examples/landcover.tif&quot;</span>)</span>
<span id="cb41-2"><a href="spatial-analysis.html#cb41-2" aria-hidden="true" tabindex="-1"></a>landcover</span></code></pre></div>
<pre><code>## class      : RasterLayer 
## dimensions : 18675, 14838, 277099650  (nrow, ncol, ncell)
## resolution : 30, 30  (x, y)
## extent     : 229319.6, 674459.6, 4094414, 4654664  (xmin, xmax, ymin, ymax)
## crs        : +proj=utm +zone=12 +datum=NAD83 +units=m +no_defs 
## source     : landcover.tif 
## names      : landcover 
## values     : 137, 584  (min, max)</code></pre>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="spatial-analysis.html#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(landcover)</span>
<span id="cb43-2"><a href="spatial-analysis.html#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(sites_sf_proj), <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">add =</span> T)</span></code></pre></div>
<p><img src="_main_files/figure-html/landcover-1.png" width="672" /></p>
<p><code>extract</code> returns a vector whose indices match the indices of the spatial object. We could leave it as a vector, or we could automatically attach it to the dataframe using <code>$</code></p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="spatial-analysis.html#cb44-1" aria-hidden="true" tabindex="-1"></a>sites_sf_proj<span class="sc">$</span>land_value <span class="ot">&lt;-</span> raster<span class="sc">::</span><span class="fu">extract</span>(landcover, sites_sf_proj)</span></code></pre></div>
<p>(Note that I put <code>raster::</code> in front of <code>extract()</code>, that’s because there are multiple packages that have a function called <code>extract()</code>, so we want to specify to R which pacakage we want)</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="spatial-analysis.html#cb45-1" aria-hidden="true" tabindex="-1"></a>sites_sf_proj</span></code></pre></div>
<pre><code>## Simple feature collection with 15 features and 2 fields
## Geometry type: POINT
## Dimension:     XY
## Bounding box:  xmin: 287581.9 ymin: 4104593 xmax: 656513.7 ymax: 4624671
## Projected CRS: NAD83 / UTM zone 12N
## First 10 features:
##    Site                 geometry land_value
## 1     1 POINT (516801.7 4188305)        547
## 2     2 POINT (470663.6 4322073)        491
## 3     3 POINT (656513.7 4212358)        561
## 4     4 POINT (311534.1 4398520)        498
## 5     5 POINT (454023.6 4595255)        187
## 6     6 POINT (455210.1 4289185)        151
## 7     7 POINT (420826.5 4351553)        457
## 8     8 POINT (564670.6 4513862)        152
## 9     9 POINT (287581.9 4469956)        458
## 10   10 POINT (377495.7 4157301)        158</code></pre>
<p>Ok, but what do these numbers mean? Our landcover raster is a categorical raster, so these numbers aren’t actually real numbers but represent a habitat type. Fortunately we have a dataframe indicating what these numbers mean.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="spatial-analysis.html#cb47-1" aria-hidden="true" tabindex="-1"></a>land_info <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;Data/Examples/landcover_info.csv&quot;</span>)</span>
<span id="cb47-2"><a href="spatial-analysis.html#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(land_info)[,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code></pre></div>
<pre><code>##   Value ClassCode         ClassName SubClassCode               SubClassName
## 1     1         1 Forest &amp; Woodland          1.A Tropical Forest &amp; Woodland
## 2     2         1 Forest &amp; Woodland          1.A Tropical Forest &amp; Woodland
## 3     3         1 Forest &amp; Woodland          1.A Tropical Forest &amp; Woodland
## 4     4         1 Forest &amp; Woodland          1.A Tropical Forest &amp; Woodland
## 5     5         1 Forest &amp; Woodland          1.A Tropical Forest &amp; Woodland
## 6     6         1 Forest &amp; Woodland          1.A Tropical Forest &amp; Woodland</code></pre>
<p>The column “Value” corresponds to the cell value we extracted from the raster. We can use what we learned earlier how to join two tables together. In our previous example, the columns we used to join the tables together were named the same. In this case, they’re not: one is called “land_value” and one is called “Value”. We could rename them so that they match. But <code>left_join()</code> has a way of handling and matching columns, even if they’re not named the same. If we check <code>?left_join</code>, in the “Arguments” section for <code>by</code>, it says “to join by different variables on x and y, use a named vector. For example, <code>by = c("a" = "b")</code> will match <code>x$a</code> to <code>y$b</code>.” So we just need to set <code>by = c("land_value" = "Value")</code></p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="spatial-analysis.html#cb49-1" aria-hidden="true" tabindex="-1"></a>sites_sf_land <span class="ot">&lt;-</span> sites_sf_proj <span class="sc">%&gt;%</span></span>
<span id="cb49-2"><a href="spatial-analysis.html#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(land_info, <span class="fu">c</span>(<span class="st">&quot;land_value&quot;</span> <span class="ot">=</span> <span class="st">&quot;Value&quot;</span>)) </span>
<span id="cb49-3"><a href="spatial-analysis.html#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(sites_sf_land)[,<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>]</span></code></pre></div>
<pre><code>## Simple feature collection with 6 features and 6 fields
## Geometry type: POINT
## Dimension:     XY
## Bounding box:  xmin: 311534.1 ymin: 4188305 xmax: 656513.7 ymax: 4595255
## Projected CRS: NAD83 / UTM zone 12N
##   Site land_value ClassCode                            ClassName SubClassCode
## 1    1        547         6                 Open Rock Vegetation          3.B
## 2    2        491         3                 Desert &amp; Semi-Desert          3.B
## 3    3        561         9 Introduced &amp; Semi Natural Vegetation          9.A
## 4    4        498         3                 Desert &amp; Semi-Desert          3.B
## 5    5        187         1                    Forest &amp; Woodland          1.B
## 6    6        151         1                    Forest &amp; Woodland          1.B
##                           SubClassName                 geometry
## 1   Cool Semi-Desert Scrub &amp; Grassland POINT (516801.7 4188305)
## 2   Cool Semi-Desert Scrub &amp; Grassland POINT (470663.6 4322073)
## 3 Introduced &amp; Semi Natural Vegetation POINT (656513.7 4212358)
## 4   Cool Semi-Desert Scrub &amp; Grassland POINT (311534.1 4398520)
## 5 Temperate &amp; Boreal Forest &amp; Woodland POINT (454023.6 4595255)
## 6 Temperate &amp; Boreal Forest &amp; Woodland POINT (455210.1 4289185)</code></pre>
<p><img src="_main_files/figure-html/plotLandPoints-1.png" width="672" /></p>
<p>Awesome! Now we know what habitat each of our sites reside in.</p>
</div>
<div id="distance" class="section level2 hasAnchor" number="4.5">
<h2><span class="header-section-number">4.5</span> Distance<a href="spatial-analysis.html#distance" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Let’s say we needed to know how far from a major road each of our sites are. We’ll use the function <code>st_distance</code> for our <code>sf</code> objects. We simply need to input the focal feature (the sites) and the feature</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="spatial-analysis.html#cb51-1" aria-hidden="true" tabindex="-1"></a>dist <span class="ot">&lt;-</span> <span class="fu">st_distance</span>(sites_sf_proj, fwy_sf_proj)</span>
<span id="cb51-2"><a href="spatial-analysis.html#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(dist)</span></code></pre></div>
<pre><code>## [1]   15 1849</code></pre>
<p>What did this do? Why are there so many columns? Remember that our Utah highways feature is a <strong>poly</strong>line, meaning it’s a line of lines. If we look at the dimensions of the highways feature:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="spatial-analysis.html#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(fwy_sf_proj)</span></code></pre></div>
<pre><code>## [1] 1849</code></pre>
<p>There are <strong>1849</strong> lines (i.e. roads) that make up this whole feature. So <code>st_distance</code> found the distance for each site (the number of rows) for <em>every</em> road (the number of columns). This <em>could</em> be useful information, but presumably we want just the distance of the <em>closest</em> road. Let’s first use <code>st_nearest_feature</code> to find the closest road to each of our sites.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="spatial-analysis.html#cb55-1" aria-hidden="true" tabindex="-1"></a>near_road <span class="ot">&lt;-</span> <span class="fu">st_nearest_feature</span>(sites_sf_proj, fwy_sf_proj)</span>
<span id="cb55-2"><a href="spatial-analysis.html#cb55-2" aria-hidden="true" tabindex="-1"></a>near_road</span></code></pre></div>
<pre><code>##  [1]  139   49 1183 1749  111  422  552 1236  786 1725  866 1632 1235 1789 1183</code></pre>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="spatial-analysis.html#cb57-1" aria-hidden="true" tabindex="-1"></a>fwy_sf_proj[near_road,]</span></code></pre></div>
<pre><code>## Simple feature collection with 15 features and 7 fields
## Geometry type: LINESTRING
## Dimension:     XY
## Bounding box:  xmin: 259156.6 ymin: 4191682 xmax: 668287.6 ymax: 4651339
## Projected CRS: NAD83 / UTM zone 12N
## First 10 features:
##      OBJECTID    FULLNAME    NAME POSTTYPE SPEED_LMT                  UNIQUE_ID
## 139     29109 I-70 EB FWY I-70 EB      FWY        75 12SWH795644729_I-70 EB_FWY
## 49      11531 I-70 WB FWY I-70 WB      FWY        75  12SVH54839499_I-70 WB_FWY
## 1183   251055 I-70 EB FWY I-70 EB      FWY        75  12SXJ29161112_I-70 EB_FWY
## 1749   370330 I-15 SB FWY I-15 SB      FWY        75  12SVJ06965812_I-15 SB_FWY
## 111     23828 I-15 NB FWY I-15 NB      FWY        65  12TVL12119352_I-15 NB_FWY
## 422     85982 I-70 EB FWY I-70 EB      FWY        75  12SVH54609503_I-70 EB_FWY
## 552    114417 I-15 NB FWY I-15 NB      FWY        75  12SVJ06495248_I-15 NB_FWY
## 1236   261732 I-80 EB FWY I-80 EB      FWY        75  12TVL93086448_I-80 EB_FWY
## 786    163578 I-80 EB FWY I-80 EB      FWY        75  12TTL83931218_I-80 EB_FWY
## 1725   366067 I-15 NB FWY I-15 NB      FWY        65  12SUG39329184_I-15 NB_FWY
##      Shape__Len                       geometry
## 139   6313.6949 LINESTRING (501467.1 429944...
## 49   25339.8240 LINESTRING (451479.6 430335...
## 1183 22123.4009 LINESTRING (620558.6 431124...
## 1749 10301.8918 LINESTRING (406729.3 435416...
## 111    847.6180 LINESTRING (412098.9 459321...
## 422  24825.7352 LINESTRING (451472.2 430330...
## 552   3780.5714 LINESTRING (406210.8 435105...
## 1236 10483.0273 LINESTRING (491047.8 456117...
## 786  65407.7733 LINESTRING (259156.6 451364...
## 1725   595.1667 LINESTRING (339154.3 419168...</code></pre>
<p>Now we have the indices of the roads that are closest to our sites, so we can find the distance of <em>just</em> these roads.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="spatial-analysis.html#cb59-1" aria-hidden="true" tabindex="-1"></a>dist_near_road <span class="ot">&lt;-</span> <span class="fu">st_distance</span>(sites_sf_proj, fwy_sf_proj[near_road,])</span>
<span id="cb59-2"><a href="spatial-analysis.html#cb59-2" aria-hidden="true" tabindex="-1"></a>dist_near_road[, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code></pre></div>
<pre><code>## Units: [m]
##            [,1]       [,2]      [,3]      [,4]      [,5]
##  [1,] 111639.22 115156.425 160869.50 199057.70 418229.34
##  [2,]  38224.11  26693.741 150285.83  71534.76 277396.29
##  [3,] 174084.35 208821.328 100145.04 287228.78 452539.69
##  [4,] 214222.37 169238.640 321112.90 103257.14 219135.01
##  [5,] 299594.45 291914.127 329236.81 238021.59  41943.65
##  [6,]  47380.39   4153.164 166813.37  81069.68 307073.34
##  [7,]  96013.51  57122.399 203759.33  14336.38 241821.38
##  [8,] 221639.27 238987.560 210186.43 218026.31 171974.51
##  [9,] 273536.65 233707.943 368867.75 162447.94 175207.56
## [10,] 188607.07 156625.451 287710.95 199018.77 437287.03
## [11,] 162543.66 187841.119 148034.96 183109.32 212418.35
## [12,] 197634.39 185366.284 256627.10 257073.93 491856.29
## [13,] 365762.29 342083.273 424603.72 273413.08  83841.36
## [14,] 230482.17 264671.131 173229.70 266273.67 257345.82
## [15,] 150861.64 192013.022  47122.16 261637.00 406153.16</code></pre>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="spatial-analysis.html#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(dist_near_road)</span></code></pre></div>
<pre><code>## [1] 15 15</code></pre>
<p>This is still giving us the distance of each road to each site but we just want the distance between each site and it’s nearest road. There’s an argument in <code>st_distance()</code> called <code>by_element</code> that tells <code>st_distance()</code> to only find the distance between the first elements of the two objects.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="spatial-analysis.html#cb63-1" aria-hidden="true" tabindex="-1"></a>dist_near_road <span class="ot">&lt;-</span> <span class="fu">st_distance</span>(sites_sf_proj, fwy_sf_proj[near_road,],</span>
<span id="cb63-2"><a href="spatial-analysis.html#cb63-2" aria-hidden="true" tabindex="-1"></a>                              <span class="at">by_element =</span> <span class="cn">TRUE</span>)</span>
<span id="cb63-3"><a href="spatial-analysis.html#cb63-3" aria-hidden="true" tabindex="-1"></a>dist_near_road</span></code></pre></div>
<pre><code>## Units: [m]
##  [1] 111639.222  26693.741 100145.037 103257.143  41943.649   4125.821
##  [7]  14283.745  86312.191  41938.755  51488.234 123300.966 155219.714
## [13]  29553.171 145427.114  47122.155</code></pre>
<p>There we go! Now we have the distance between each site and it’s nearest road. This output is a vector, so we can add it to our sites data frame with <code>$</code> (or <code>mutate()</code> in <code>tidyverse</code>)</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="spatial-analysis.html#cb65-1" aria-hidden="true" tabindex="-1"></a>sites_sf_proj<span class="sc">$</span>dist_near_road <span class="ot">&lt;-</span> dist_near_road</span>
<span id="cb65-2"><a href="spatial-analysis.html#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(sites_sf_proj)</span></code></pre></div>
<pre><code>## Simple feature collection with 6 features and 3 fields
## Geometry type: POINT
## Dimension:     XY
## Bounding box:  xmin: 311534.1 ymin: 4188305 xmax: 656513.7 ymax: 4595255
## Projected CRS: NAD83 / UTM zone 12N
##   Site                 geometry land_value dist_near_road
## 1    1 POINT (516801.7 4188305)        547 111639.222 [m]
## 2    2 POINT (470663.6 4322073)        491  26693.741 [m]
## 3    3 POINT (656513.7 4212358)        561 100145.037 [m]
## 4    4 POINT (311534.1 4398520)        498 103257.143 [m]
## 5    5 POINT (454023.6 4595255)        187  41943.649 [m]
## 6    6 POINT (455210.1 4289185)        151   4125.821 [m]</code></pre>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="spatial-analysis.html#cb67-1" aria-hidden="true" tabindex="-1"></a>sites_sf_proj <span class="ot">&lt;-</span> sites_sf_proj <span class="sc">%&gt;%</span></span>
<span id="cb67-2"><a href="spatial-analysis.html#cb67-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dist_near_road =</span> dist_near_road)</span></code></pre></div>
<p>(Note that if you look at the help file i.e. <code>?st_distance</code>, there are other functions to calculate geometric measurements for <code>sf</code> objects: <code>st_area</code> and <code>st_length</code>)</p>
</div>
<div id="calculate-terrain-characteristics" class="section level2 hasAnchor" number="4.6">
<h2><span class="header-section-number">4.6</span> Calculate Terrain Characteristics<a href="spatial-analysis.html#calculate-terrain-characteristics" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>From a DEM (digital elevation model) we can obtain a lot of other rasters that are likely useful in GIS research. The elevation raster we’ve been working with is a DEM. From a DEM we can derive other terrain characteristics :</p>
<ul>
<li>Slope: Measurement of “steepness”</li>
<li>Aspect: Measurements of “Northness” and “Eastness”</li>
<li>Flow direction of water: the direction of the greatest drop in elevation</li>
<li>Terrain Ruggedness Index (TRI): the mean of the absolute differences between the value of a cell and the value of its 8 surrounding cells</li>
<li>Topographic Position Index (TPI): the difference between the value of a cell and the mean value of its 8 surrounding cells</li>
<li>Roughness: the difference between the maximum and the minimum value of a cell and its 8 surrounding cells</li>
</ul>
<p>These definitions came from the help file for the function we can use to derive these characteristics: <code>terrain()</code>.</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="spatial-analysis.html#cb68-1" aria-hidden="true" tabindex="-1"></a>slope <span class="ot">&lt;-</span> <span class="fu">terrain</span>(elev_snow_stk<span class="sc">$</span>elevation, <span class="at">opt =</span> <span class="st">&quot;slope&quot;</span>, <span class="at">unit =</span> <span class="st">&quot;radians&quot;</span>)</span>
<span id="cb68-2"><a href="spatial-analysis.html#cb68-2" aria-hidden="true" tabindex="-1"></a>aspect <span class="ot">&lt;-</span> <span class="fu">terrain</span>(elev_snow_stk<span class="sc">$</span>elevation, <span class="at">opt =</span> <span class="st">&quot;aspect&quot;</span>, <span class="at">unit =</span> <span class="st">&quot;radians&quot;</span>)</span>
<span id="cb68-3"><a href="spatial-analysis.html#cb68-3" aria-hidden="true" tabindex="-1"></a>roughness <span class="ot">&lt;-</span> <span class="fu">terrain</span>(elev_snow_stk<span class="sc">$</span>elevation, <span class="at">opt =</span> <span class="st">&quot;roughness&quot;</span>)</span>
<span id="cb68-4"><a href="spatial-analysis.html#cb68-4" aria-hidden="true" tabindex="-1"></a>terrain_stk <span class="ot">&lt;-</span> <span class="fu">stack</span>(elev_snow_stk<span class="sc">$</span>elevation, slope, aspect, roughness)</span>
<span id="cb68-5"><a href="spatial-analysis.html#cb68-5" aria-hidden="true" tabindex="-1"></a>terrain_stk</span></code></pre></div>
<pre><code>## class      : RasterStack 
## dimensions : 7401, 5606, 41490006, 4  (nrow, ncol, ncell, nlayers)
## resolution : 30, 30  (x, y)
## extent     : 414639.5, 582819.5, 4428230, 4650260  (xmin, xmax, ymin, ymax)
## crs        : +proj=utm +zone=12 +datum=NAD83 +units=m +no_defs 
## names      :   elevation,       slope,      aspect,   roughness 
## min values :    1279.897,       0.000,       0.000,       0.000 
## max values : 4111.600098,    1.302171,    6.283185,  279.081787</code></pre>
<p><img src="_main_files/figure-html/loadStk-1.png" width="672" /></p>
<p>To compute the Northness or Eastness of a cell, we actually have to do one more step to the aspect raster. Aspect is a circular measurement (which is why its units are in degrees or radians), so (if you remember how trigonometry works) to calculate northness and eastness we need to use cosine and sine respectively. Because our units are in radians, we can simply apply the <code>cos()</code> and <code>sin()</code> functions directly to the aspect raster.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="spatial-analysis.html#cb70-1" aria-hidden="true" tabindex="-1"></a>aspect_cos <span class="ot">&lt;-</span> <span class="fu">cos</span>(terrain_stk<span class="sc">$</span>aspect)</span>
<span id="cb70-2"><a href="spatial-analysis.html#cb70-2" aria-hidden="true" tabindex="-1"></a>aspect_sin <span class="ot">&lt;-</span> <span class="fu">sin</span>(terrain_stk<span class="sc">$</span>aspect)</span>
<span id="cb70-3"><a href="spatial-analysis.html#cb70-3" aria-hidden="true" tabindex="-1"></a>aspect_stk <span class="ot">&lt;-</span> <span class="fu">stack</span>(aspect_cos, aspect_sin)</span>
<span id="cb70-4"><a href="spatial-analysis.html#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(aspect_stk) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;cosine_northness&quot;</span>, <span class="st">&quot;sine_eastness&quot;</span>)</span>
<span id="cb70-5"><a href="spatial-analysis.html#cb70-5" aria-hidden="true" tabindex="-1"></a>aspect_stk</span></code></pre></div>
<pre><code>## class      : RasterStack 
## dimensions : 7401, 5606, 41490006, 2  (nrow, ncol, ncell, nlayers)
## resolution : 30, 30  (x, y)
## extent     : 414639.5, 582819.5, 4428230, 4650260  (xmin, xmax, ymin, ymax)
## crs        : +proj=utm +zone=12 +datum=NAD83 +units=m +no_defs 
## names      : cosine_northness, sine_eastness 
## min values :               -1,            -1 
## max values :                1,             1</code></pre>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="spatial-analysis.html#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(aspect_stk)</span></code></pre></div>
<p><img src="_main_files/figure-html/cosSine-1.png" width="672" /></p>
</div>
<div id="re-classify-rasters" class="section level2 hasAnchor" number="4.7">
<h2><span class="header-section-number">4.7</span> Re-Classify Rasters<a href="spatial-analysis.html#re-classify-rasters" class="anchor-section" aria-label="Anchor link to header"></a></h2>
</div>
<div id="raster-cell-stats" class="section level2 hasAnchor" number="4.8">
<h2><span class="header-section-number">4.8</span> Raster Cell Stats<a href="spatial-analysis.html#raster-cell-stats" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In my research I often have to perform cell algebra or focal statistics. Maybe you need to know the average elevation or the total herbaceous biomass within a certain area. The way to get these values are with the function <code>cellStats</code>. We simply need to input the raster and the <code>stat</code> function: <code>sum</code>, <code>mean</code>, <code>min</code>, <code>max</code>, <code>sd</code>, or a homemade function. Let’s say we need to calculate some stats of the elevation, SWE, and snow depth within a 5-km area around our sites.</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="spatial-analysis.html#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(elev_snow_stk<span class="sc">$</span>elevation)</span>
<span id="cb73-2"><a href="spatial-analysis.html#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(sites_sf_proj), <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">add =</span> T)</span></code></pre></div>
<p><img src="_main_files/figure-html/plotSites-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>We need to know which of our sites are within the extent of the raster. There are probably many ways of doing this. The most straightforward way I can think of getting just the sites that fall within the raster are 1) extracting raster data at each site and 2) filtering to just the sites that have raster data attached.</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="spatial-analysis.html#cb74-1" aria-hidden="true" tabindex="-1"></a>sites_rast <span class="ot">&lt;-</span> raster<span class="sc">::</span><span class="fu">extract</span>(elev_snow_stk, sites_sf_proj)</span>
<span id="cb74-2"><a href="spatial-analysis.html#cb74-2" aria-hidden="true" tabindex="-1"></a>sites_rast <span class="co"># notice how only 3 rows (sites) have data</span></span></code></pre></div>
<pre><code>##       elevation swe snow_depth
##  [1,]        NA  NA         NA
##  [2,]        NA  NA         NA
##  [3,]        NA  NA         NA
##  [4,]        NA  NA         NA
##  [5,]  2002.799 300        975
##  [6,]        NA  NA         NA
##  [7,]        NA  NA         NA
##  [8,]  3111.935 302       1094
##  [9,]        NA  NA         NA
## [10,]        NA  NA         NA
## [11,]  1600.460  89        439
## [12,]        NA  NA         NA
## [13,]        NA  NA         NA
## [14,]        NA  NA         NA
## [15,]        NA  NA         NA</code></pre>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="spatial-analysis.html#cb76-1" aria-hidden="true" tabindex="-1"></a>sites_sf_proj <span class="ot">&lt;-</span> <span class="fu">cbind</span>(sites_sf_proj, <span class="fu">as.data.frame</span>(sites_rast)) <span class="co"># convert the matrix into a a data frame</span></span>
<span id="cb76-2"><a href="spatial-analysis.html#cb76-2" aria-hidden="true" tabindex="-1"></a>sites_sf_proj</span></code></pre></div>
<pre><code>## Simple feature collection with 15 features and 6 fields
## Geometry type: POINT
## Dimension:     XY
## Bounding box:  xmin: 287581.9 ymin: 4104593 xmax: 656513.7 ymax: 4624671
## Projected CRS: NAD83 / UTM zone 12N
## First 10 features:
##    Site land_value dist_near_road elevation swe snow_depth
## 1     1        547 111639.222 [m]        NA  NA         NA
## 2     2        491  26693.741 [m]        NA  NA         NA
## 3     3        561 100145.037 [m]        NA  NA         NA
## 4     4        498 103257.143 [m]        NA  NA         NA
## 5     5        187  41943.649 [m]  2002.799 300        975
## 6     6        151   4125.821 [m]        NA  NA         NA
## 7     7        457  14283.745 [m]        NA  NA         NA
## 8     8        152  86312.191 [m]  3111.935 302       1094
## 9     9        458  41938.755 [m]        NA  NA         NA
## 10   10        158  51488.234 [m]        NA  NA         NA
##                    geometry
## 1  POINT (516801.7 4188305)
## 2  POINT (470663.6 4322073)
## 3  POINT (656513.7 4212358)
## 4  POINT (311534.1 4398520)
## 5  POINT (454023.6 4595255)
## 6  POINT (455210.1 4289185)
## 7  POINT (420826.5 4351553)
## 8  POINT (564670.6 4513862)
## 9  POINT (287581.9 4469956)
## 10 POINT (377495.7 4157301)</code></pre>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="spatial-analysis.html#cb78-1" aria-hidden="true" tabindex="-1"></a>sites_sf_rast <span class="ot">&lt;-</span> sites_sf_proj <span class="sc">%&gt;%</span></span>
<span id="cb78-2"><a href="spatial-analysis.html#cb78-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(elevation) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(swe) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(snow_depth))</span>
<span id="cb78-3"><a href="spatial-analysis.html#cb78-3" aria-hidden="true" tabindex="-1"></a>sites_sf_rast</span></code></pre></div>
<pre><code>## Simple feature collection with 3 features and 6 fields
## Geometry type: POINT
## Dimension:     XY
## Bounding box:  xmin: 454023.6 ymin: 4450000 xmax: 568976.1 ymax: 4595255
## Projected CRS: NAD83 / UTM zone 12N
##   Site land_value dist_near_road elevation swe snow_depth
## 1    5        187   41943.65 [m]  2002.799 300        975
## 2    8        152   86312.19 [m]  3111.935 302       1094
## 3   11        457  123300.97 [m]  1600.460  89        439
##                   geometry
## 1 POINT (454023.6 4595255)
## 2 POINT (564670.6 4513862)
## 3 POINT (568976.1 4450000)</code></pre>
<p>Let’s just do this for one of our sites for now and then we can try it with the others.</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="spatial-analysis.html#cb80-1" aria-hidden="true" tabindex="-1"></a>site_sf_rast_01 <span class="ot">&lt;-</span> sites_sf_rast[<span class="dv">1</span>,]</span></code></pre></div>
<p>First, we need to know which parts of this raster are within 5-km of the site, so we will need to crop the raster. We can do that by first making a buffer with <code>st_buffer()</code></p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="spatial-analysis.html#cb81-1" aria-hidden="true" tabindex="-1"></a>site_buff_5km <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(site_sf_rast_01, <span class="dv">5000</span>) <span class="co"># units are in meters, 1000m = 1km</span></span>
<span id="cb81-2"><a href="spatial-analysis.html#cb81-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-3"><a href="spatial-analysis.html#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(elev_snow_stk[[<span class="dv">1</span>]]) <span class="co"># let&#39;s just plot one layer for demonstration</span></span>
<span id="cb81-4"><a href="spatial-analysis.html#cb81-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(site_buff_5km), <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">add =</span> T)</span></code></pre></div>
<p><img src="_main_files/figure-html/buffer-1.png" width="672" /></p>
<p>Now let’s crop the raster to this buffer’s extent. We’ll use the function <code>crop()</code>, which takes in the raster object we want to crop and an “extent object, or any object from which an Extent object can be extracted” (quoted from the <code>crop</code> help file). Because we can make an extent object from our buffer</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="spatial-analysis.html#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">extent</span>(site_buff_5km)</span></code></pre></div>
<pre><code>## class      : Extent 
## xmin       : 449023.6 
## xmax       : 459023.6 
## ymin       : 4590255 
## ymax       : 4600255</code></pre>
<p>We can input our buffer object directly into <code>crop()</code></p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="spatial-analysis.html#cb84-1" aria-hidden="true" tabindex="-1"></a>stack_crop <span class="ot">&lt;-</span> <span class="fu">crop</span>(elev_snow_stk, site_buff_5km)</span></code></pre></div>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="spatial-analysis.html#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(stack_crop[[<span class="dv">1</span>]])</span>
<span id="cb85-2"><a href="spatial-analysis.html#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(site_buff_5km), <span class="at">add =</span> T)</span>
<span id="cb85-3"><a href="spatial-analysis.html#cb85-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(site_sf_rast_01), <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">add =</span> T)</span></code></pre></div>
<p><img src="_main_files/figure-html/plotSilent-1.png" width="672" /></p>
<p>Great! Now let’s calculate the mean, median, min/max, and standard deviation of the elevation, SWE, and snow depth within this area.</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="spatial-analysis.html#cb86-1" aria-hidden="true" tabindex="-1"></a>stack_stats <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb86-2"><a href="spatial-analysis.html#cb86-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean_5km =</span> <span class="fu">cellStats</span>(stack_crop, <span class="at">stat =</span> <span class="st">&quot;mean&quot;</span>),</span>
<span id="cb86-3"><a href="spatial-analysis.html#cb86-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">median_5km =</span> <span class="fu">cellStats</span>(stack_crop, <span class="at">stat =</span> <span class="st">&quot;median&quot;</span>),</span>
<span id="cb86-4"><a href="spatial-analysis.html#cb86-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_5km =</span> <span class="fu">cellStats</span>(stack_crop, <span class="at">stat =</span> <span class="st">&quot;min&quot;</span>),</span>
<span id="cb86-5"><a href="spatial-analysis.html#cb86-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">max_5km =</span> <span class="fu">cellStats</span>(stack_crop, <span class="at">stat =</span> <span class="st">&quot;max&quot;</span>),</span>
<span id="cb86-6"><a href="spatial-analysis.html#cb86-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd_5km =</span> <span class="fu">cellStats</span>(stack_crop, <span class="at">stat =</span> <span class="st">&quot;sd&quot;</span>))</span>
<span id="cb86-7"><a href="spatial-analysis.html#cb86-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-8"><a href="spatial-analysis.html#cb86-8" aria-hidden="true" tabindex="-1"></a><span class="co"># let&#39;s add a column for the environment type from the raster and remove the row names</span></span>
<span id="cb86-9"><a href="spatial-analysis.html#cb86-9" aria-hidden="true" tabindex="-1"></a>stack_stats<span class="sc">$</span>environment <span class="ot">&lt;-</span> <span class="fu">row.names</span>(stack_stats)</span>
<span id="cb86-10"><a href="spatial-analysis.html#cb86-10" aria-hidden="true" tabindex="-1"></a><span class="fu">row.names</span>(stack_stats) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb86-11"><a href="spatial-analysis.html#cb86-11" aria-hidden="true" tabindex="-1"></a>stack_stats</span></code></pre></div>
<pre><code>##    mean_5km median_5km  min_5km max_5km   sd_5km environment
## 1 2226.9138   2155.127 1791.435    2751 248.3925   elevation
## 2  355.8968    337.000  216.000     608 108.8653         swe
## 3 1162.7375   1099.000  726.000    1925 342.0622  snow_depth</code></pre>
<p>We have our stats, but we want to join them with our sites data frame to make them more meaningful. We can’t use the function <code>cbind()</code> because the number of rows don’t match up. Instead, we can use <code>dyplyr</code>’s function <code>bind_cols()</code>, which works just like <code>cbind()</code> or <code>do.call(cbind, x)</code> except that it’s a bit smarter and can add <code>NA</code>s if the number of rows or columns doesn’t match.</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="spatial-analysis.html#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_cols</span>(site_sf_rast_01, stack_stats)</span></code></pre></div>
<pre><code>## Simple feature collection with 3 features and 12 fields
## Geometry type: POINT
## Dimension:     XY
## Bounding box:  xmin: 454023.6 ymin: 4595255 xmax: 454023.6 ymax: 4595255
## Projected CRS: NAD83 / UTM zone 12N
##   Site land_value dist_near_road elevation swe snow_depth  mean_5km median_5km
## 1    5        187   41943.65 [m]  2002.799 300        975 2226.9138   2155.127
## 2    5        187   41943.65 [m]  2002.799 300        975  355.8968    337.000
## 3    5        187   41943.65 [m]  2002.799 300        975 1162.7375   1099.000
##    min_5km max_5km   sd_5km environment                 geometry
## 1 1791.435    2751 248.3925   elevation POINT (454023.6 4595255)
## 2  216.000     608 108.8653         swe POINT (454023.6 4595255)
## 3  726.000    1925 342.0622  snow_depth POINT (454023.6 4595255)</code></pre>
<p>Great! But we only did this process for one site when presumabaly we would want these data for all available sites. We could copy and paste for each site, but that can get tedious, not to mention out of control if we had more than 3 sites. So the best way to do this would be with <strong>loops</strong>.</p>
</div>
<div id="a-note-about-loops" class="section level2 hasAnchor" number="4.9">
<h2><span class="header-section-number">4.9</span> A Note About Loops<a href="spatial-analysis.html#a-note-about-loops" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Learning all these functions is all well and good, but what if you have to perform them all on multiple features or rasters? Of course, you can always copy and paste, but that can soon become confusing and messy and cause your code to be inefficient. The better way to address this is with loops! <code>for</code> loops and <code>lapply</code> are lifesavers and I use them in all of my code. A previous workshop went into more depth on how to use loops, so I won’t go over them in too much detail. But I do want to show some ways you can use them for GIS applications.</p>
<p>(These code chunks are for demonstration only, these data and directories don’t actually exist)</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="spatial-analysis.html#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example 1: Load a set of shapefiles and find the area for each</span></span>
<span id="cb90-2"><a href="spatial-analysis.html#cb90-2" aria-hidden="true" tabindex="-1"></a>filenames <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir) <span class="co"># get a list of shapefile names in a directory</span></span>
<span id="cb90-3"><a href="spatial-analysis.html#cb90-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-4"><a href="spatial-analysis.html#cb90-4" aria-hidden="true" tabindex="-1"></a>area_list <span class="ot">&lt;-</span> <span class="fu">c</span>() <span class="co"># create an empty vector for the areas to live in </span></span>
<span id="cb90-5"><a href="spatial-analysis.html#cb90-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-6"><a href="spatial-analysis.html#cb90-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(filenames)){</span>
<span id="cb90-7"><a href="spatial-analysis.html#cb90-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load the shapefile</span></span>
<span id="cb90-8"><a href="spatial-analysis.html#cb90-8" aria-hidden="true" tabindex="-1"></a>  shp <span class="ot">&lt;-</span> <span class="fu">st_read</span>(filenames[i])</span>
<span id="cb90-9"><a href="spatial-analysis.html#cb90-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb90-10"><a href="spatial-analysis.html#cb90-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate the area</span></span>
<span id="cb90-11"><a href="spatial-analysis.html#cb90-11" aria-hidden="true" tabindex="-1"></a>  area <span class="ot">&lt;-</span> <span class="fu">st_area</span>(shp)</span>
<span id="cb90-12"><a href="spatial-analysis.html#cb90-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb90-13"><a href="spatial-analysis.html#cb90-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># put the area into the vector</span></span>
<span id="cb90-14"><a href="spatial-analysis.html#cb90-14" aria-hidden="true" tabindex="-1"></a>  area_list <span class="ot">&lt;-</span> <span class="fu">c</span>(area_list, area)</span>
<span id="cb90-15"><a href="spatial-analysis.html#cb90-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb90-16"><a href="spatial-analysis.html#cb90-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-17"><a href="spatial-analysis.html#cb90-17" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------X</span></span>
<span id="cb90-18"><a href="spatial-analysis.html#cb90-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-19"><a href="spatial-analysis.html#cb90-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Example 2: Load a set of shapefiles, generate a buffer for each, and calculate the  #            mean value of a raster within that buffer and the focal feature</span></span>
<span id="cb90-20"><a href="spatial-analysis.html#cb90-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-21"><a href="spatial-analysis.html#cb90-21" aria-hidden="true" tabindex="-1"></a>filenames <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir) <span class="co"># get a list of shapefile names in a directory</span></span>
<span id="cb90-22"><a href="spatial-analysis.html#cb90-22" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> <span class="fu">raster</span>(raster_filename) <span class="co"># load a raster</span></span>
<span id="cb90-23"><a href="spatial-analysis.html#cb90-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-24"><a href="spatial-analysis.html#cb90-24" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(filenames, <span class="cf">function</span>(fn){</span>
<span id="cb90-25"><a href="spatial-analysis.html#cb90-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load a shapefile</span></span>
<span id="cb90-26"><a href="spatial-analysis.html#cb90-26" aria-hidden="true" tabindex="-1"></a>  shp <span class="ot">&lt;-</span> <span class="fu">st_read</span>(fn)</span>
<span id="cb90-27"><a href="spatial-analysis.html#cb90-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb90-28"><a href="spatial-analysis.html#cb90-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># generate a 10kmX10km buffer </span></span>
<span id="cb90-29"><a href="spatial-analysis.html#cb90-29" aria-hidden="true" tabindex="-1"></a>  buffer <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(shp, <span class="at">dist =</span> <span class="dv">10000</span>)</span>
<span id="cb90-30"><a href="spatial-analysis.html#cb90-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb90-31"><a href="spatial-analysis.html#cb90-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># crop the raster to the shape and the buffer</span></span>
<span id="cb90-32"><a href="spatial-analysis.html#cb90-32" aria-hidden="true" tabindex="-1"></a>  r_shp <span class="ot">&lt;-</span> <span class="fu">crop</span>(r, <span class="fu">extent</span>(shp))</span>
<span id="cb90-33"><a href="spatial-analysis.html#cb90-33" aria-hidden="true" tabindex="-1"></a>  r_buffer <span class="ot">&lt;-</span> <span class="fu">crop</span>(r, <span class="fu">extent</span>(buffer))</span>
<span id="cb90-34"><a href="spatial-analysis.html#cb90-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb90-35"><a href="spatial-analysis.html#cb90-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate the mean value of the raster within the buffer and the feature</span></span>
<span id="cb90-36"><a href="spatial-analysis.html#cb90-36" aria-hidden="true" tabindex="-1"></a>  r_shp_mean <span class="ot">&lt;-</span> <span class="fu">cellStats</span>(r_shp, <span class="at">stat =</span> <span class="st">&quot;mean&quot;</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb90-37"><a href="spatial-analysis.html#cb90-37" aria-hidden="true" tabindex="-1"></a>  r_buff_mean <span class="ot">&lt;-</span> <span class="fu">cellStats</span>(r_shp, <span class="at">stat =</span> <span class="st">&quot;mean&quot;</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb90-38"><a href="spatial-analysis.html#cb90-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb90-39"><a href="spatial-analysis.html#cb90-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># return both means in a list</span></span>
<span id="cb90-40"><a href="spatial-analysis.html#cb90-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(r_shp_mean, r_buff_mean))</span>
<span id="cb90-41"><a href="spatial-analysis.html#cb90-41" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb90-42"><a href="spatial-analysis.html#cb90-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-43"><a href="spatial-analysis.html#cb90-43" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------X</span></span>
<span id="cb90-44"><a href="spatial-analysis.html#cb90-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-45"><a href="spatial-analysis.html#cb90-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Example 3: Generate a raster of the sum from a set of RasterStacks</span></span>
<span id="cb90-46"><a href="spatial-analysis.html#cb90-46" aria-hidden="true" tabindex="-1"></a><span class="co">#            and then save the output raster</span></span>
<span id="cb90-47"><a href="spatial-analysis.html#cb90-47" aria-hidden="true" tabindex="-1"></a>filenames <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir) <span class="co"># get a list of raster files in a directory</span></span>
<span id="cb90-48"><a href="spatial-analysis.html#cb90-48" aria-hidden="true" tabindex="-1"></a>out_names <span class="ot">&lt;-</span> <span class="fu">paste0</span>(filenames, <span class="st">&quot;_sum&quot;</span>)</span>
<span id="cb90-49"><a href="spatial-analysis.html#cb90-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-50"><a href="spatial-analysis.html#cb90-50" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(filenames), <span class="cf">function</span>(i){</span>
<span id="cb90-51"><a href="spatial-analysis.html#cb90-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load RasterStak</span></span>
<span id="cb90-52"><a href="spatial-analysis.html#cb90-52" aria-hidden="true" tabindex="-1"></a>  stk <span class="ot">&lt;-</span> <span class="fu">stack</span>(filenames[i])</span>
<span id="cb90-53"><a href="spatial-analysis.html#cb90-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb90-54"><a href="spatial-analysis.html#cb90-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create a raster that is the sum of all layers in the stack</span></span>
<span id="cb90-55"><a href="spatial-analysis.html#cb90-55" aria-hidden="true" tabindex="-1"></a>  sum <span class="ot">&lt;-</span> <span class="fu">calc</span>(stk, <span class="at">fun =</span> sum)</span>
<span id="cb90-56"><a href="spatial-analysis.html#cb90-56" aria-hidden="true" tabindex="-1"></a>  sum <span class="ot">&lt;-</span> <span class="fu">sum</span>(stk) <span class="co"># these two operations are equivalent</span></span>
<span id="cb90-57"><a href="spatial-analysis.html#cb90-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb90-58"><a href="spatial-analysis.html#cb90-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeRaster</span>(sum, out_names[i], <span class="at">format =</span> <span class="st">&quot;GTiff&quot;</span>)</span>
<span id="cb90-59"><a href="spatial-analysis.html#cb90-59" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb90-60"><a href="spatial-analysis.html#cb90-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-61"><a href="spatial-analysis.html#cb90-61" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------X</span></span>
<span id="cb90-62"><a href="spatial-analysis.html#cb90-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-63"><a href="spatial-analysis.html#cb90-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Example 4: Pull the number of zeros in a set of rasters</span></span>
<span id="cb90-64"><a href="spatial-analysis.html#cb90-64" aria-hidden="true" tabindex="-1"></a>filenames <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir) <span class="co"># get a list of raster files in a directory</span></span>
<span id="cb90-65"><a href="spatial-analysis.html#cb90-65" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(filenames, <span class="cf">function</span>(fn){</span>
<span id="cb90-66"><a href="spatial-analysis.html#cb90-66" aria-hidden="true" tabindex="-1"></a>  <span class="co"># load raster</span></span>
<span id="cb90-67"><a href="spatial-analysis.html#cb90-67" aria-hidden="true" tabindex="-1"></a>  rast <span class="ot">&lt;-</span> <span class="fu">raster</span>(fn)</span>
<span id="cb90-68"><a href="spatial-analysis.html#cb90-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb90-69"><a href="spatial-analysis.html#cb90-69" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get the number of zeros in the raster</span></span>
<span id="cb90-70"><a href="spatial-analysis.html#cb90-70" aria-hidden="true" tabindex="-1"></a>  n_0 <span class="ot">&lt;-</span> <span class="fu">getValues</span>(rast) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">%&gt;%</span></span>
<span id="cb90-71"><a href="spatial-analysis.html#cb90-71" aria-hidden="true" tabindex="-1"></a>      <span class="fu">which</span>() <span class="sc">%&gt;%</span></span>
<span id="cb90-72"><a href="spatial-analysis.html#cb90-72" aria-hidden="true" tabindex="-1"></a>      <span class="fu">length</span>()</span>
<span id="cb90-73"><a href="spatial-analysis.html#cb90-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(n_0)</span>
<span id="cb90-74"><a href="spatial-analysis.html#cb90-74" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>Even more efficient would be to run these in parallel, but that is way beyond the scope of this workshop</p>
<hr />
<p>I hope these functions helped you! The next chapter goes over some ways of obtaining the data we worked on today.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="spatial-data-in-r.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="where-to-obtain-data-further-resources.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://https://github.com/ronanhart/R_spatial_workshop/03-Spatial_analysis.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
